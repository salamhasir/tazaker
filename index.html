<script>
  // Ø±Ø§Ø¨Ø· Google Script
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbx0xI2XKn5fZAaL5kM9Vr1RQJMH77Pe59swEt84RGO-Ksp3nqnC6YEKb_3IInWNMP8k/exec";
  const PROXY = "https://corsproxy.io/?" + encodeURIComponent(SHEET_URL);

  // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const date = new Date(dateStr);
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('ar-SA', options);
    } catch {
      return dateStr;
    }
  }

  async function loadTickets() {
    try {
      const res = await fetch(PROXY);
      const text = await res.text();

      // Ø¯Ø¹Ù… ØµÙŠØºØªÙŠÙ† Ù…Ø®ØªÙ„ÙØªÙŠÙ† Ù…Ù† JSON
      let tickets;
      try {
        tickets = JSON.parse(text);
      } catch {
        const parsed = JSON.parse(text);
        tickets = JSON.parse(parsed.contents || "[]");
      }

      const container = document.getElementById('tickets');
      container.innerHTML = '';

      tickets.forEach((t, i) => {
        const status = (t['Ø­Ø§Ù„Ø© Ø§Ù„ØªØ°ÙƒØ±Ø©'] || '').trim();
        const colorClass = status.includes('ØªØ­Øª') ? 'red' : status.includes('ØªÙ…') ? 'green' : '';

        const title = t['Ù†ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø©'] || 'ØªØ°ÙƒØ±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
        const summary = t['Ù…Ù„Ø®Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰'] ? t['Ù…Ù„Ø®Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰'].substring(0, 80) + '...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø®Øµ';
        const date = formatDate(t['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒØ±Ø©']);
        const person = t['Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©'] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const handler = t['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'] || 'Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯';

        const div = document.createElement('div');
        div.className = 'ticket';
        div.innerHTML = `
          <h3 style="color:#006c35; font-size:20px; margin-bottom:6px;">${title}</h3>
          <p style="color:#666; font-size:14px; margin-bottom:8px;">ğŸ’¬ ${summary}</p>
          <p style="margin:4px 0;">ğŸ—“ï¸ ${date}</p>
          <p style="margin:4px 0;">ğŸ‘¤ ${person}</p>
          <p style="margin:4px 0;">ğŸ‘¨â€ğŸ’¼ ${handler}</p>
          <span class="status ${colorClass}">${status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
        `;

        div.addEventListener('click', () => {
          const id = i + 1;
          window.location.href = `ticket.html?id=${id}`;
        });
        container.appendChild(div);
      });

      if (!tickets.length) {
        container.innerHTML = '<p>âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
      }

    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      document.getElementById('tickets').innerHTML =
        '<p style="color:red">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­ ÙˆÙ…ÙØªÙˆØ­ Ù„Ù„Ø¹Ø§Ù…Ø©.</p>';
    }
  }

  loadTickets();
</script>
