<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ°Ø§ÙƒØ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: #f4f7f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    header {
      background: #006c35;
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }

    /* Ø§Ù„ÙÙ„ØªØ± */
    .filter-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: white;
      border: 2px solid #006c35;
      color: #006c35;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    .filter-btn.active, .filter-btn:hover {
      background: #006c35;
      color: white;
    }

    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© */
    .ticket {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      padding: 15px 20px;
      margin-bottom: 15px;
      transition: 0.3s;
      cursor: pointer;
      line-height: 1.6;
    }
    .ticket:hover {
      background: #eaf9ee;
      transform: scale(1.01);
    }
    .ticket h3 {
      margin: 0 0 5px 0;
      color: #006c35;
      font-size: 20px;
    }
    .ticket p {
      margin: 2px 0;
      font-size: 14px;
      color: #333;
    }
    .status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      margin-top: 8px;
      font-size: 13px;
    }
    .status.red { background: #ffd6d6; color: #b30000; }
    .status.green { background: #d6ffde; color: #007a2a; }

    .no-data {
      text-align: center;
      color: #888;
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <header>
  <h1>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</h1>
  <p style="
    margin: 5px 0 0;
    font-size: 15px;
    color: #e4e4e4;
    font-weight: 400;
  ">
    Ù…ØªØ§Ø¨Ø¹Ø© ØªØ°Ø§ÙƒØ± Ù†Ø¸Ø§Ù… ØªÙˆØ§ØµÙ„ Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚
  </p>
</header>


  <!-- âœ… Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© -->
  <div class="filter-bar">
    <button class="filter-btn active" data-status="all">Ø§Ù„ÙƒÙ„</button>
    <button class="filter-btn" data-status="ØªØ­Øª">ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</button>
    <button class="filter-btn" data-status="ØªÙ…">Ù…Ù†Ø¬Ø²</button>
  </div>

  <div id="tickets">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbx0xI2XKn5fZAaL5kM9Vr1RQJMH77Pe59swEt84RGO-Ksp3nqnC6YEKb_3IInWNMP8k/exec";
    const PROXY = "https://corsproxy.io/?" + encodeURIComponent(SHEET_URL);

    let allTickets = [];

    // ğŸ”¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„Ù‡Ø¬Ø±ÙŠ
    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        const options = { year: 'numeric', month: 'long', day: 'numeric', calendar: 'islamic-umalqura' };
        return new Intl.DateTimeFormat('ar-SA', options).format(date) + ' Ù‡Ù€';
      } catch {
        return dateStr;
      }
    }

    // ğŸ”¹ Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ°Ø§ÙƒØ±
    function renderTickets(tickets, filter = "all") {
      const container = document.getElementById('tickets');
      container.innerHTML = '';

      // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      const filtered = tickets.filter(t => {
        const status = (t['Ø­Ø§Ù„Ø© Ø§Ù„ØªØ°ÙƒØ±Ø©'] || '').trim();
        if (filter === "all") return true;
        return status.includes(filter);
      });

      if (!filtered.length) {
        container.innerHTML = '<p class="no-data">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©.</p>';
        return;
      }

      filtered.forEach((t, i) => {
        const status = (t['Ø­Ø§Ù„Ø© Ø§Ù„ØªØ°ÙƒØ±Ø©'] || '').trim();
        const colorClass = status.includes('ØªØ­Øª') ? 'red' : status.includes('ØªÙ…') ? 'green' : '';

        const title = t['Ù†ÙˆØ¹ Ø§Ù„ØªØ°ÙƒØ±Ø©'] || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
        const summary = t['Ù…Ù„Ø®Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰'] ? t['Ù…Ù„Ø®Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰'].substring(0, 80) + '...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø®Øµ';
        const date = formatDate(t['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒØ±Ø©']);
        const submitter = t['Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©'] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const handler = t['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'] || 'Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯';

        const div = document.createElement('div');
        div.className = 'ticket';
        div.innerHTML = `
          <h3>${title}</h3>
          <p>ğŸ’¬ ${summary}</p>
          <p>ğŸ“… ${date}</p>
          <p>ğŸ‘¤ ${submitter}</p>
          <p>ğŸ‘¨â€ğŸ’¼ <b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</b> ${handler}</p>
          <span class="status ${colorClass}">${status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
        `;
        div.addEventListener('click', () => {
          const id = i + 1;
          window.location.href = `ticket.html?id=${id}`;
        });
        container.appendChild(div);
      });
    }

    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§
    async function loadTickets() {
      const container = document.getElementById('tickets');
      container.innerHTML = "<p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>";

      try {
        const res = await fetch(PROXY);
        const text = await res.text();

        let tickets;
        try {
          tickets = JSON.parse(text);
        } catch {
          const parsed = JSON.parse(text);
          tickets = JSON.parse(parsed.contents || "[]");
        }

        // âœ… ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
        tickets.sort((a, b) => new Date(b['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒØ±Ø©']) - new Date(a['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒØ±Ø©']));

        allTickets = tickets;
        renderTickets(allTickets);

      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", err);
        container.innerHTML = '<p style="color:red;text-align:center;">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
      }
    }

    // ğŸ”¹ Ø±Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ±
    document.addEventListener("DOMContentLoaded", () => {
      const buttons = document.querySelectorAll(".filter-btn");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const filterValue = btn.dataset.status;
          renderTickets(allTickets, filterValue);
        });
      });

      loadTickets();
    });
  </script>

</body>
</html>
